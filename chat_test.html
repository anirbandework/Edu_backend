<!DOCTYPE html>
<html>
<head>
    <title>Chat Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin: 5px; }
        input, select { padding: 5px; margin: 5px; }
        .response { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat API Test Client</h1>
        
        <div class="section">
            <h3>Configuration</h3>
            <label>Server URL:</label>
            <input type="text" id="serverUrl" value="http://127.0.0.1:8000" style="width: 300px;">
            <br>
            <label>User Type:</label>
            <select id="userType">
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
            </select>
        </div>

        <div class="section">
            <h3>Test Data</h3>
            <p><strong>Student ID:</strong> 27d33111-7c42-4e34-953b-5e92b2f6537d</p>
            <p><strong>Teacher ID:</strong> 4f2be8ad-999e-4e40-a6e1-e0e55485a2e0</p>
            <p><strong>Tenant ID:</strong> 351e3b19-0c37-4e48-a06d-3ceaa7e584c2</p>
            <p><strong>School Authority ID:</strong> 25227d19-074b-4481-b376-53e6d7b85676</p>
            <p><strong>Chat Room ID:</strong> 3a2667e8-a410-4b24-854c-c8147711d1c0</p>
        </div>

        <div class="section">
            <h3>API Tests</h3>
            <button onclick="testStudentChats()">Get Student Chats</button>
            <button onclick="testTeacherChats()">Get Teacher Chats</button>
            <button onclick="testChatHistory()">Get Chat History</button>
            <button onclick="testSendMessage()">Send Test Message</button>
        </div>

        <div class="section">
            <h3>WebSocket Test</h3>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="disconnectWebSocket()">Disconnect</button>
            <button onclick="joinRoom()">Join Chat Room</button>
            <button onclick="sendWSMessage()">Send WS Message</button>
            <div id="wsStatus">Not connected</div>
        </div>

        <div class="section">
            <h3>Response</h3>
            <div id="response" class="response">Ready to test...</div>
        </div>
    </div>

    <script>
        const testData = {
            studentId: '27d33111-7c42-4e34-953b-5e92b2f6537d',
            teacherId: '4f2be8ad-999e-4e40-a6e1-e0e55485a2e0',
            tenantId: '351e3b19-0c37-4e48-a06d-3ceaa7e584c2',
            schoolAuthorityId: '25227d19-074b-4481-b376-53e6d7b85676',
            chatRoomId: '3a2667e8-a410-4b24-854c-c8147711d1c0'
        };

        let ws = null;

        function getServerUrl() {
            return document.getElementById('serverUrl').value;
        }

        function getUserType() {
            return document.getElementById('userType').value;
        }

        function showResponse(data, isError = false) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = JSON.stringify(data, null, 2);
            responseDiv.className = isError ? 'response error' : 'response success';
        }

        async function apiCall(endpoint) {
            try {
                const response = await fetch(`${getServerUrl()}${endpoint}`);
                const data = await response.json();
                
                if (!response.ok) {
                    showResponse({error: `HTTP ${response.status}`, details: data}, true);
                } else {
                    showResponse(data);
                }
            } catch (error) {
                showResponse({error: error.message}, true);
            }
        }

        function testStudentChats() {
            const endpoint = `/api/v1/chat/student/${testData.studentId}/chats?tenant_id=${testData.tenantId}`;
            apiCall(endpoint);
        }

        function testTeacherChats() {
            const endpoint = `/api/v1/chat/teacher/${testData.teacherId}/chats?tenant_id=${testData.tenantId}`;
            apiCall(endpoint);
        }

        function testChatHistory() {
            const endpoint = `/api/v1/chat/history/${testData.chatRoomId}`;
            apiCall(endpoint);
        }

        async function testSendMessage() {
            try {
                const userType = getUserType();
                const response = await fetch(`${getServerUrl()}/api/v1/chat/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        teacher_id: testData.teacherId,
                        student_id: testData.studentId,
                        tenant_id: testData.tenantId,
                        message: `Test message from ${userType} at ${new Date().toLocaleTimeString()}`,
                        sender_type: userType
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    showResponse({error: `HTTP ${response.status}`, details: data}, true);
                } else {
                    showResponse(data);
                }
            } catch (error) {
                showResponse({error: error.message}, true);
            }
        }

        function connectWebSocket() {
            const userType = getUserType();
            const userId = userType === 'student' ? testData.studentId : testData.teacherId;
            const wsUrl = `ws://127.0.0.1:8000/ws/chat?user_id=${userId}&user_type=${userType}&tenant_id=${testData.tenantId}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                document.getElementById('wsStatus').textContent = `Connected as ${userType}`;
                showResponse({status: 'WebSocket connected', userType: userType});
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                showResponse({type: 'WebSocket message', data: data});
            };
            
            ws.onclose = function(event) {
                document.getElementById('wsStatus').textContent = 'Disconnected';
                showResponse({status: 'WebSocket disconnected'});
            };
            
            ws.onerror = function(error) {
                showResponse({error: 'WebSocket error', details: error}, true);
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function joinRoom() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'join_room',
                    chat_room_id: testData.chatRoomId
                }));
                showResponse({action: 'Sent join_room message'});
            } else {
                showResponse({error: 'WebSocket not connected'}, true);
            }
        }

        function sendWSMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const userType = getUserType();
                ws.send(JSON.stringify({
                    type: 'send_message',
                    chat_room_id: testData.chatRoomId,
                    message: `WebSocket test message from ${userType} at ${new Date().toLocaleTimeString()}`
                }));
                showResponse({action: 'Sent WebSocket message'});
            } else {
                showResponse({error: 'WebSocket not connected'}, true);
            }
        }
    </script>
</body>
</html>